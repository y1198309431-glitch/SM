# 常见问题

1. 训练过程中出现nan.
   可以尝试关闭AMP混合精度训练.(train.py中加amp=False)
2. 固定640*640尺寸的解决方案.
    遇到这种类似报错解决如下：RuntimeError: shape '[8, 151, 151, -1]' is invalid for input of size 11698176
    
    运行train.py中的时候需要在ultralytics/models/yolo/detect/train.py的DetectionTrainer class中的build_dataset函数中的rect=mode == 'val'改为rect=False.其他模型可以修改回去.  
    运行val.py的时候,把val.py的rect=False注释取消即可.其他模型可以修改回去.  
    运行predict.py中的时候需要在ultralytics/engine/predictor.py找到函数def pre_transform(self, im),在LetterBox中的auto改为False,其他模型可以修改回去.

4. 生成coco评价指标报错，记得看我视频教程

5. 在运行时，如何解决这个问题 RuntimeError: Not implemented on the CPU
   1.首先找到\ultralytics-main\ultralytics\nn\task.py下的class DetectionModel(BaseModel)，替换如下代码:

        # Build strides
        m = self.model[-1]  # Detect()
        if isinstance(m, Detect):  # includes all Detect subclasses like Segment, Pose, OBB, WorldDetect
            s = 640  # 2x min stride
            m.inplace = self.inplace

            forward = lambda x: self.forward(x)[0] if isinstance(m, (Segment, Pose, OBB)) else self.forward(x)
            if isinstance(m, v10Detect):
                forward = lambda x: self.forward(x)["one2many"]

            try:
                m.stride = torch.tensor([s / x.shape[-2] for x in forward(torch.zeros(2, ch, s, s))])  # forward
            except RuntimeError as e:
                if 'Not implemented on the CPU' in str(e) or 'Input type (torch.FloatTensor) and weight type (torch.cuda.FloatTensor)' \
                        in str(e) or 'CUDA tensor' in str(e) or 'is_cuda()' in str(e) or 'carafe_forward_impl' in str(e):
                    self.model.to(torch.device('cuda'))
                    m.stride = torch.tensor([s / x.shape[-2] for x in forward(torch.zeros(2, ch, s, s).to(torch.device('cuda')))])  # forward
                else:
                    raise e
            self.stride = m.stride
            m.bias_init()  # only run once
        else:
            self.stride = torch.Tensor([32])  # default stride for i.e. RTDETR

        # Init weights, biases
        initialize_weights(self)
        if verbose:
            self.info()
            LOGGER.info("")

6. 训练过程中不打印GFLOpS
      找到如下文件'ultralytics/utils/torch_utils.py' 中的 def get_flops(model, imgsz=640):参考修改

         def get_flops(model, imgsz=640):
             """Return a YOLO model's FLOPs."""
             if not thop:
                 return 0.0  # if not installed return 0.0 GFLOPs
      
             try: 
                 model = de_parallel(model)
                 p = next(model.parameters())
                 if not isinstance(imgsz, list):
                     imgsz = [imgsz, imgsz]  # expand if int/float
                 try:
                     # Use stride size for input tensor
                     # stride = max(int(model.stride.max()), 32) if hasattr(model, "stride") else 32  # max stride
                     stride = 640
                     im = torch.empty((1, 3, stride, stride), device=p.device)  # input image in BCHW format
                     flops = thop.profile(deepcopy(model), inputs=[im], verbose=False)[0] / 1e9 * 2  # stride GFLOPs
                     return flops * imgsz[0] / stride * imgsz[1] / stride  # imgsz GFLOPs
                 except Exception:
                     # Use actual image size for input tensor (i.e. required for RTDETR models)
                     im = torch.empty((1, 3, *imgsz), device=p.device)  # input image in BCHW format
                     return thop.profile(deepcopy(model), inputs=[im], verbose=False)[0] / 1e9 * 2  # imgsz GFLOPs
             except Exception:
                 return 0.0
7.  SystemError: <method 'draw_rectangle' of 'ImagingDraw' objects> 出现这个问题解决方法如下：
    找到这个文件 ultralytics\utils\plotting.py 中的 def box_label()方法 358行
    使用这个 self.draw.text((box[0], box[1]), label, fill=txt_color, font=self.font, anchor='ls')  # for PIL>8.0
     # self.draw.text((p1[0], p1[1] - h if outside else p1[1]), label, fill=txt_color, font=self.font)
8.  TensorBoard: WARNING ⚠️ TensorBoard graph visualization failure  
  # ifdef __HIPCC__nvrtc: error: failed to open nvrtc-builtins64_121.dll.
    Make sure that nvrtc-builtins64_121.dll is installed correctly.
    当遇到这个报错，需要重新创建一个环境，或是安装一下torch-2.2.1版本，我在这个环境下运行是没问题的
     
9. 使用train.py 脚本多卡训练

from ultralytics import YOLO  as YOLO
import warnings
warnings.filterwarnings('ignore')
if __name__ ==  '__main__':
    os.environ["CUDA_VISIBLE_DEVICES"]="0,1"
    # 加载一个模型
    model = YOLO('模型权重')  # 加载预训练模型（推荐用于训练）
    # 训练模型
    results = model.train(data='数据集yaml文件', epochs=100, imgsz=640, batch=8, device=[0,1], workers=8)

在终端使用指令运行： python -m torch.distributed.launch --nproc_per_node=2 train.py



